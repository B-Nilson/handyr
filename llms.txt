# handyr

The goal of handyr is to streamline common datascience tasks with
wrappers around various handy packages in a consistent style.

## Installation

You can install the development version of handyr from
[GitHub](https://github.com/) with:

``` r
# install.packages("pak")
pak::pak("B-Nilson/handyr")
```

## Examples

### Create and write/read/delete from Databases

``` r
library(handyr)

# Create a file-based database (or setup postgresql server if on Windows)
db <- create_database("test", type = "sqlite")
# or type = "duckdb"
# or type = "postgresql" (if on Windows)

# Write data to an existing database
db |> 
  write_to_database(
    new_data = datasets::airquality,
    table_name = "airquality",
    primary_keys = c("Month", "Day"),
    insert_new = TRUE, # set to FALSE to ignore entries not already in db
    update_duplicates = FALSE # set to TRUE to update existing entries in db where overlap exists
  )

# Read data from a database, leverage dplyr for common sql queries
db |>
  read_from_database(
    table_name = "airquality",
    query_fun = \(df) df |> dplyr::filter(Month == 5, Day == 5),
    # Set to FALSE to return a lazy tbl of the query instead of loading full results into memory
    collect = TRUE 
  )

# Delete matching entries in a database table
db |>
  delete_database_entries(
    table_name = "airquality",
    entry_keys = data.frame(Month = 5, Day = 5:8)
  )
```

### Record/log Steps in a Workflow

``` r
library(handyr)

# Initiate logging entry
logs = list(log_step("handyr Examples", header = TRUE, time = FALSE))

# Then log each step
logs$something <- log_step("doing something")

# do something 

# End logging
logs$complete <- log_step("done")

# Summarise logs timing
summarise_logs(logs)
```

### Forget about for loops

``` r

# TODO: examples showcasing for_each
```

### Spatial / Temporal Data Manipulation

``` r

# Local timezone lookup
get_timezone(lng = -105.053144, lat = 69.116178)

# Detailed season description
c(Sys.time() - 10^7, Sys.time()) |>
  get_season(as_factor = TRUE, include_year = TRUE, include_months = TRUE)

# Split large date ranges into specific-size chunks
c(Sys.time() - 10^8, Sys.time()) |>
  split_date_range(max_duration = "120 days")

# Get most likely data interval (useful for when occasional gaps may exist)
get_step(c(1:10, 12, 14, 16:20))

# Convert sf objects back to data frames cleanly
cities <- data.frame(
    name = c("Nanaimo", "Port Moody", "Prince George"),
    x = c(-124.0531, -122.8519, -122.7949),
    y = c(49.1633, 49.2844, 53.8934)
  )
cities_sf <- cities |>
  sf::st_as_sf(coords = c("x", "y"), crs = "WGS84")
sf_as_df(cities_sf)

# Or just get the x/y coordinates as a data.frame
extract_sf_coords(cities_sf)
```

### Miscellaneous Quality of Life Improvments

``` r
library(handyr)

# Vector operations
x <- c(1:10 + 0.123, NA) |>
  clamp(range = c(2, 9)) |> # replace values outside range with nearest value
  swap(2, with = NA) |> # swap out all "2"s with NA
  rolling("mean", width = 3, direction = "backwards", .min_non_na = 2) |> # 3-point (fast) rolling mean
  truncate(digits = 1) |> # drop all digits after the first
  convert_units(from = "m", to = "km") |> # convert from metres to kilometres
  max(na.rm = TRUE) # take the max (or `min()` or `mode()`) with consistent NA handling

# Error handling
load_your_data <- function(x) {
  if(x %in% c(2, 4)) {
    stop("Something went wrong") # simulate file not existing or some other error
  } else{
    data.frame(x = x, y = x^2) # simulate data being loaded in
  } 
}
your_data <- 1:5 |> for_each(
  # Capture error, convert to warning, return NULL, keep going
  # or use a custom warning message instead (i.e. `.warn = "Failed to load data."`)
  \(x) load_your_data(x) |> on_error(.return = NULL, .warn = TRUE)
  .bind = TRUE
)

# TODO: showcase join_list, do_if, save_figure, silence
# TODO: showcase max/min NA handling improvements
# TODO: showcase rolling built-ins speed improvements
```

# Package index

## All functions

- [`as.data.frame(`*`<Interval>`*`)`](https://b-nilson.github.io/handyr/reference/as.data.frame.Interval.md)
  : Convert an Interval object to a data frame

- [`as_interval()`](https://b-nilson.github.io/handyr/reference/as_interval.md)
  : Create an Interval object from a date range

- [`check_date_range()`](https://b-nilson.github.io/handyr/reference/check_date_range.md)
  : Check that a vector of two dates within a specified date range

- [`check_urls_exist()`](https://b-nilson.github.io/handyr/reference/check_urls_exist.md)
  : Check if URLs exist and can be reached

- [`clamp()`](https://b-nilson.github.io/handyr/reference/clamp.md) :
  Replace out-of-range values with the nearest in-range value

- [`connect_to_database()`](https://b-nilson.github.io/handyr/reference/connect_to_database.md)
  : Create a connection to a database

- [`convert_units()`](https://b-nilson.github.io/handyr/reference/convert_units.md)
  : Convert between common units

- [`create_database()`](https://b-nilson.github.io/handyr/reference/create_database.md)
  : Create a file-based database

- [`create_database_table()`](https://b-nilson.github.io/handyr/reference/create_database_table.md)
  : Create table if not already existing

- [`delete_database_entries()`](https://b-nilson.github.io/handyr/reference/delete_database_entries.md)
  : Delete specific entries from a database table.

- [`do_if()`](https://b-nilson.github.io/handyr/reference/do_if.md) :
  Apply a function if a condition is met

- [`do_if_enough()`](https://b-nilson.github.io/handyr/reference/do_if_enough.md)
  : Apply a function if enough values are non-NA

- [`extract_sf_coords()`](https://b-nilson.github.io/handyr/reference/extract_sf_coords.md)
  : Add sf coordinates and crs as columns

- [`for_each()`](https://b-nilson.github.io/handyr/reference/for_each.md)
  : Loop over a vector-like object and apply a function

- [`get_and_unzip()`](https://b-nilson.github.io/handyr/reference/get_and_unzip.md)
  : Get a zip file and unzip it

- [`get_communities()`](https://b-nilson.github.io/handyr/reference/get_communities.md)
  : Get a communities within a region from OpenStreetMap

- [`get_file_index()`](https://b-nilson.github.io/handyr/reference/get_file_index.md)
  : Get a file index from a URL

- [`get_precision()`](https://b-nilson.github.io/handyr/reference/get_precision.md)
  : Get the number of decimal places in a numeric vector

- [`get_season()`](https://b-nilson.github.io/handyr/reference/get_season.md)
  : Get the season from a date

- [`get_step()`](https://b-nilson.github.io/handyr/reference/get_step.md)
  : Determine most common distance between values

- [`get_timezone()`](https://b-nilson.github.io/handyr/reference/get_timezone.md)
  : Lookup timezones of latitude/longitude pairs

- [`is_within()`](https://b-nilson.github.io/handyr/reference/is_within.md)
  : Check if a date is within an interval

- [`join_list()`](https://b-nilson.github.io/handyr/reference/join_list.md)
  : Join a list of data frames

- [`log_step()`](https://b-nilson.github.io/handyr/reference/log_step.md)
  : Log a message for script progress tracking

- [`max()`](https://b-nilson.github.io/handyr/reference/max.md)
  [`min()`](https://b-nilson.github.io/handyr/reference/max.md) : Get
  the maximum/minimum value while handling NAs cleanly

- [`mode()`](https://b-nilson.github.io/handyr/reference/mode.md) : Get
  the most common value

- [`on_error()`](https://b-nilson.github.io/handyr/reference/on_error.md)
  [`on_warning()`](https://b-nilson.github.io/handyr/reference/on_error.md)
  : Control what happens when an error/warning occurs

- [`read_from_database()`](https://b-nilson.github.io/handyr/reference/read_from_database.md)
  : Read data from a database

- [`rolling()`](https://b-nilson.github.io/handyr/reference/rolling.md)
  : Apply a function over a rolling window

- [`save_figure()`](https://b-nilson.github.io/handyr/reference/save_figure.md)
  : Save a ggplot2 figure for publishing

- [`sentence_range()`](https://b-nilson.github.io/handyr/reference/sentence_range.md)
  : Convert a sequence of numbers to a human-readable string

- [`seq(`*`<Interval>`*`)`](https://b-nilson.github.io/handyr/reference/seq.Interval.md)
  : Extend seq() to work with Intervals

- [`sf_as_df()`](https://b-nilson.github.io/handyr/reference/sf_as_df.md)
  : Convert an sf object to a data.frame

- [`shorten_number()`](https://b-nilson.github.io/handyr/reference/shorten_number.md)
  : Shorten a number to a string with a unit prefix (e.g. "1K", "10M",
  "100B")

- [`silence()`](https://b-nilson.github.io/handyr/reference/silence.md)
  : Silence unwanted output

- [`split_date_range()`](https://b-nilson.github.io/handyr/reference/split_date_range.md)
  : Split a date range into multiple, shorter date ranges

- [`summarise_logs()`](https://b-nilson.github.io/handyr/reference/summarise_logs.md)
  :

  Log overall and individual run time for repeated
  [`log_step()`](https://b-nilson.github.io/handyr/reference/log_step.md)
  calls

- [`swap()`](https://b-nilson.github.io/handyr/reference/swap.md) : Swap
  out values in a vector

- [`truncate()`](https://b-nilson.github.io/handyr/reference/truncate.md)
  : Truncate a numeric vector to a certain number of decimal places

- [`write_to_database()`](https://b-nilson.github.io/handyr/reference/write_to_database.md)
  : Write data to a database

